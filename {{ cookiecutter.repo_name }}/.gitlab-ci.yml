{% set bot_envvar = cookiecutter.scm_namespace.upper().split() | join('-') ~ '_BOT_API_TOKEN' if cookiecutter.scm_platform == 'GitLab Premium/Ultimate' else 'PROJECT_BOT_TOKEN' -%}
# GitLab CI documentation at:
# https://docs.gitlab.com/ci/

# UPDATEME to suit your project's workflow
# General pipeline configuration
stages:
  # Initial stages
  - security-checks
  - test
  - coverage
  - build
  - sign
  - entrust
{%- if cookiecutter.create_docker %}
  # Stages for Docker-related jobs
  - container-build
  - container-security
  - container-test
  # Later stages
{%- endif %}
  - publish
  - release
  - maintenance

# TODO Set up a bot for automated repository actions and components
# 1. Create a Project Access Token at {{ cookiecutter.__scm_link_url }}/settings/access_tokens
# 2. Ensure token has "Maintainer" role and "api" scope
# 3. Set the {{ bot_envvar }} variable in {{ cookiecutter.__scm_link_url }}/settings/ci_cd
# 4. Ensure variable has at least "Masked" option flagged and "Protect variable" unchecked
include:
  - component: $CI_SERVER_FQDN/components/sast/sast@3.2.0
    inputs:
      stage: security-checks
      enable_mr_pipelines: true
{%- if cookiecutter.scm_platform == 'GitLab Premium/Ultimate' %}
      run_advanced_sast: true
  - component: $CI_SERVER_FQDN/components/dependency-scanning/main@0.9.1
    inputs:
      stage: security-checks
{%- endif %}
  - component: $CI_SERVER_FQDN/components/secret-detection/secret-detection@2.2.0
    inputs:
      stage: security-checks
      enable_mr_pipelines: true
  - component: $CI_SERVER_FQDN/components/slsa/provenance-signer@0.1.1
    rules:
      - if: $CI_COMMIT_TAG =~ $SEMVER_ANY_VERSION
      - if: $CI_MERGE_REQUEST_TITLE =~ /^Draft\:.*/i
        changes:
          paths: *codechecks
        when: manual
      - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
        changes:
          paths: *codechecks
    inputs:
      stage: sign
      job_name: slsa-signer-wheel
      target_artifact: dist/$WHEEL_BINARY
      bundle_file: slsa-signed/$WHEEL_BINARY.slsa-l3-provenance.json
      provenance_metadata_file: $PROVENANCE_METADATA
  - component: $CI_SERVER_FQDN/components/slsa/provenance-signer@0.1.1
    rules:
      - if: $CI_COMMIT_TAG =~ $SEMVER_ANY_VERSION
      - if: $CI_MERGE_REQUEST_TITLE =~ /^Draft\:.*/i
        changes:
          paths: *codechecks
        when: manual
      - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
        changes:
          paths: *codechecks
    inputs:
      stage: sign
      job_name: slsa-signer-sdist
      target_artifact: dist/$SDIST_BINARY
      bundle_file: slsa-signed/$SDIST_BINARY.slsa-l3-provenance.json
      provenance_metadata_file: $PROVENANCE_METADATA
  - component: $CI_SERVER_FQDN/components/gitlab-triage/gitlab-triage@0.1.2
    rules:
      - if: $CI_PIPELINE_SOURCE == 'schedule'
    inputs:
      api_token: ${{ bot_envvar }}
      stage: maintenance
{%- if cookiecutter.create_docker %}
  - component: $CI_SERVER_FQDN/components/container-scanning/container-scanning@5.1.0
    inputs:
      stage: container-security
      job_name: container-scanning
      enable_mr_pipelines: true
    rules:
      - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      - if: $CI_COMMIT_TAG =~ $SEMVER_ANY_VERSION
  # UPDATEME if you wish to use another registry besides GitLab, see documentation at:
  # https://gitlab.com/explore/catalog/to-be-continuous/docker
  - component: $CI_SERVER_FQDN/to-be-continuous/docker/gitlab-ci-docker@6.0.0
    rules:
      - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      - if: $CI_COMMIT_TAG # FYI Fine-tuning for running only on release tags not working at upstream (https://gitlab.com/to-be-continuous/docker/-/issues/107)
    inputs:
      context-path: $CI_PROJECT_DIR
      file: $CI_PROJECT_DIR/docker/Dockerfile
      snapshot-image: "$CI_REGISTRY_IMAGE/snapshot:$CI_COMMIT_REF_SLUG-nightly"
      release-extra-tags: "latest \\g<major> \\g<major>.\\g<minor> \\g<major>.\\g<minor>.\\g<patch>"
{%- endif %}
  - component: $CI_SERVER_FQDN/galactipy/components/versioning/vars@0.4.4
  - component: $CI_SERVER_FQDN/galactipy/components/versioning/release@0.4.4
    inputs:
      pat-envvar: ${{ bot_envvar }}
      pre-release-notes: |-
        ## $QF_RELEASE_STAGE_TITLE $QF_SEMVER_VERSION

        ${CI_COMMIT_TAG_MESSAGE:-This is a $QF_RELEASE_LABEL version of $PROJECT_NAME. \*\*Do not use it in production environments.\*\*}
      changelog-commit-message: ':bookmark: Update CHANGELOG.md'
      links:
        - name: Build metadata (json)
          url: $PROVENANCE_PACKAGE/$REPO_NAME-$QF_PYPI_VERSION.slsa-l1-provenance.json
        - name: Wheel attestation (json)
          url: $PROVENANCE_PACKAGE/$WHEEL_BINARY.publish.attestation
        - name: Wheel provenance (json)
          url: $PROVENANCE_PACKAGE/$WHEEL_BINARY.slsa-l3-provenance.json
        - name: sdist attestation (json)
          url: $PROVENANCE_PACKAGE/$SDIST_BINARY.publish.attestation
        - name: sdist provenance (json)
          url: $PROVENANCE_PACKAGE/$SDIST_BINARY.slsa-l3-provenance.json

variables:
  # Variables from the Cookiecutter template
  PROJECT_NAME: {{ cookiecutter.project_name }}
  REPO_NAME: {{ cookiecutter.repo_name }}
  PACKAGE_NAME: {{ cookiecutter.package_name }}

  # Advanced regular expressions
  SEMVER_RELEASE_VERSION: /^(v)?(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)$/i
  SEMVER_ANY_VERSION: /^(v)?(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-z-][0-9a-z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-z-][0-9a-z-]*))*))?(?:\+([0-9a-z-]+(?:\.[0-9a-z-]+)*))?$/i

  # Value substitution
  PACKAGE_BUILD_ARTIFACTS: ${REPO_NAME}_build_${CI_COMMIT_SHORT_SHA}_${CI_PIPELINE_SOURCE}
  STAGE_ARTIFACTS: ${REPO_NAME}_${CI_JOB_STAGE}_${CI_COMMIT_SHORT_SHA}_${CI_PIPELINE_SOURCE}
  PROVENANCE_PACKAGE: $CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/generic/provenances/$QF_PYPI_VERSION

  PROVENANCE_METADATA: $PROVENANCE_METADATA

  WHEEL_BINARY: ${PACKAGE_NAME}-${QF_PYPI_VERSION}-py3-none-any.whl
  SDIST_BINARY: ${PACKAGE_NAME}-${QF_PYPI_VERSION}.tar.gz

default:
  image: registry.gitlab.com/galactipy/docker:{{ cookiecutter.minimal_python_version }}
  cache:
    key: venv-$CI_COMMIT_SHORT_SHA
    paths:
      - $CI_PROJECT_DIR/.cache/pypoetry

# General rules for triggering pipelines
workflow:
  rules:
{%- if cookiecutter.commit_convention == 'gitmoji' %}
    - if: $CI_COMMIT_TITLE =~ /^(\:construction|WIP)\:/i
{%- elif cookiecutter.commit_convention == 'conventional' %}
    - if: $CI_COMMIT_TITLE =~ /^WIP(\([^)]*\))?!?\:/i
{%- else %}
    - if: $CI_COMMIT_TITLE =~ /^ðŸš§\sWIP(\([^)]*\))?!?\:/i
{%- endif %}
      when: never
    - if: $CI_COMMIT_BRANCH =~ /^(test|WIP).*/i
      when: never
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH

# Anchors for common commands and file groups
.codechecks: &codechecks
  - {{ cookiecutter.package_name }}/**/*
  - tests/**/*
{%- if cookiecutter.create_docker %}
  - docker/**/*
  - .dockerignore
{%- endif %}
  - .gitignore

.filechecks: &filechecks
  - {{ cookiecutter.package_name }}/**/*
  - tests/**/*
{%- if cookiecutter.create_docker %}
  - docker/**/*
  - .dockerignore
{%- endif %}
  - pyproject.toml
  - tasks.py
  - .gitlab-ci.yml
  - .triage-policies.yml
  - .gitignore

.test_scripts: &test_scripts
  - invoke sweep

# Reusable configuration jobs
.install_project:
  before_script:
    - invoke install --ignore-pty

.test_setup:
  extends: .install_project
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == 'schedule'
      when: never
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != 'merge_request_event'
      changes:
        paths: *filechecks
        compare_to: $CI_DEFAULT_BRANCH
      when: manual
    - if: $CI_MERGE_REQUEST_TITLE =~ /^Draft\:.*/i
      changes:
        paths: *filechecks
      when: manual
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        paths: *filechecks
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  before_script:
    - invoke install --ignore-pty

.publish_rules:
  extends: .install_project
  rules:
    - if: $CI_COMMIT_TAG =~ $SEMVER_ANY_VERSION
    - if: $CI_MERGE_REQUEST_TITLE =~ /^Draft\:.*/i
      changes:
        paths: *codechecks
      when: manual
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        paths: *codechecks

.upload_to_generic_package:
  before_script:
    - |
      upload_from_dir() {
        for file in "$2/*"; do
          if [ -f "$file" ]; then
            filename=$(basename $file)
            RESPONSE=$(curl --location \
              --header "JOB-TOKEN: $CI_JOB_TOKEN" \
              --header "Content-Type: application/$3" \
              --output upload-$filename.json \
              --silent \
              --write-out "%{http_code}" \
              --upload-file "$file" \
              "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/generic/$1/$QF_PYPI_VERSION/$filename")
            if [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ]; then
              echo -e "\e[32mâœ“\e[0m Uploaded $filename"
            else
              echo -e "\e[93mâš \e[0m Failed to upload $filename"
            fi
          fi
        done
      }

# Jobs
{%- set list_python_version = cookiecutter._python_version_list_mapping[cookiecutter.minimal_python_version] %}
{%- set supported_python_versions = cookiecutter._python_version_support_mapping[cookiecutter.minimal_python_version] %}
{%- for version in supported_python_versions %}
test-py{{ version[0] }}{{ version[1] }}:
  stage: test
  image: registry.gitlab.com/galactipy/docker:{{ version[0] }}.{{ version[1] }}
  extends: .test_setup
  script:
    - *test_scripts
{%- if version[0] == list_python_version[0] and version[1] == list_python_version[1] %}
  artifacts:
    name: ${REPO_NAME}_coverage_${CI_COMMIT_SHORT_SHA}_${CI_PIPELINE_SOURCE}
    paths:
      - coverage.xml
      - test_report.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      junit: test_report.xml
    expire_in: 1 week

{{ cookiecutter.__coverage_lc }}-report:
  stage: coverage
  image: badouralix/curl-jq:latest
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != 'schedule'
  script:
{%- if cookiecutter.__coverage_lc == 'coveralls' %}
    - curl -L https://coveralls.io/coveralls-linux.tar.gz | tar -xz -C /usr/local/bin
    # TODO Set the COVERALLS_REPO_TOKEN CI/CD variable in {{ cookiecutter.__scm_link_url }}/settings/ci_cd, see documentation at:
    # https://docs.coveralls.io/#integrate-coveralls-with-your-codebase
    - coveralls report coverage.xml --repo-token $COVERALLS_REPO_TOKEN
{%- elif cookiecutter.__coverage_lc == 'codacy' %}
    - curl -Ls https://coverage.codacy.com/get.sh -o codacy.sh
    # TODO Set the CODACY_PROJECT_TOKEN CI/CD variable in {{ cookiecutter.__scm_link_url }}/settings/ci_cd, see documentation at:
    # https://docs.codacy.com/codacy-api/api-tokens/#repository-api-tokens
    - sh ./codacy.sh report -r coverage.xml
{%- endif %}
{%- endif %}
{% endfor %}
build-package:
  stage: build
  variables:
    GIT_DEPTH: 0
    RUNNER_GENERATE_ARTIFACTS_METADATA: true
  extends: .publish_rules
  script:
    - invoke build
  artifacts:
    name: $PACKAGE_BUILD_ARTIFACTS
    expire_in: never
    expose_as: build
    paths:
      - dist/

compile-provenance:
  stage: entrust
  variables:
    PROVENANCE_METADATA_RENAME: ${REPO_NAME}-${QF_PYPI_VERSION}.slsa-l1-provenance.json
  image: registry.gitlab.com/galactipy/docker/pipx:alpine
  rules:
    - if: $CI_COMMIT_TAG =~ $SEMVER_ANY_VERSION
  id_tokens:
    SIGSTORE_ID_TOKEN:
      aud: sigstore
  script:
    - pipx install pypi-attestations
    - pypi-attestations sign dist/*
    - mkdir slsa/ pypi/
    - cp dist/*.publish.attestation pypi/
    - cp $PROVENANCE_METADATA "slsa/$PROVENANCE_METADATA_RENAME"
    - cp slsa-signed/* slsa/
  artifacts:
    name: $STAGE_ARTIFACTS
    expire_in: never
    when: always
    paths:
      - dist/
      - pypi/
      - slsa/

register-provenance:
  stage: publish
  image: badouralix/curl-jq:latest
  rules:
    - if: $CI_COMMIT_TAG =~ $SEMVER_ANY_VERSION
  extends: .upload_to_generic_package
  script:
    - upload_from_dir provenances ./slsa json
    - upload_from_dir provenances ./pypi json
  after_script:
    - jq -s 'map(.)' upload-*.json > api-calls.json
  artifacts:
    name: ${REPO_NAME}_registry-uploads_${CI_COMMIT_SHORT_SHA}_${CI_PIPELINE_SOURCE}
    when: always
    paths:
      - api-calls.json

publish-test:
  stage: publish
  extends: .publish_rules
  script:
    # TODO Set the TESTPYPI_TOKEN variable for https://test.pypi.org in {{ cookiecutter.__scm_link_url }}/settings/ci_cd
    - invoke config $TESTPYPI_TOKEN --repo testpypi
    - invoke publish --repo testpypi --no-build

publish-prod:
  stage: publish
  image: registry.gitlab.com/galactipy/docker/pipx:alpine
  rules:
    - if: $CI_COMMIT_TAG =~ $SEMVER_RELEASE_VERSION
  needs:
    - compile-provenance
    - job: publish-test
      artifacts: false
  id_tokens:
    PYPI_ID_TOKEN:
      aud: pypi
  script:
    # TODO Set up trusted publishing in PyPI, see documentation at:
    # https://docs.pypi.org/trusted-publishers/creating-a-project-through-oidc/#gitlab-cicd
    - pipx install twine
    - twine upload --attestations dist/*
